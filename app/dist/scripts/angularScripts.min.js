var app=null;!function(){"use strict";app=angular.module("ajsApp",["common.services","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"])}(),function(){app.config(["$routeProvider",function($routeProvider){$routeProvider.when("/home",{templateUrl:"views/home.html",controller:"homeController",controllerAs:"vm",caseInsensitiveMatch:!0}),$routeProvider.when("/login",{templateUrl:"views/login.html",controller:"loginController",controllerAs:"vm",caseInsensitiveMatch:!0}),$routeProvider.when("/register",{templateUrl:"views/register.html",controller:"registerController",controllerAs:"vm",caseInsensitiveMatch:!0}),$routeProvider.otherwise({redirectTo:"/home"})}]),app.run(["$rootScope","$location","$cookieStore","$templateCache",function($rootScope,$location,$cookieStore,$templateCache){$rootScope.globals=$cookieStore.get("globals")||{},$rootScope.globals.currentUser,$rootScope.$on("$locationChangeStart",function(event,next,current){$rootScope.globals.currentUser&&"/login"==$location.path()&&$location.path("/home"),"/login"===$location.path()||$rootScope.globals.currentUser||$location.path("/login")})}])}(),function(){"use strict";angular.module("ajsApp").factory("AuthenticationService",["Auth","Base64","$http","$cookieStore","$rootScope","$timeout",function(Auth,Base64,$http,$cookieStore,$rootScope,$timeout){var service={};return $rootScope.displayLogout=!1,service.Login=function(username,callback){var obj={nick:username};Auth.Login(obj).$promise.then(function(response){callback(response)}).catch(function(response){callback(response)})},service.SetCredentials=function(obj){var authdata=Base64.encode(obj.Nick);$rootScope.globals={currentUser:{nick:obj.Nick,authdata:authdata}},localStorage.setItem("usrData",JSON.stringify(obj)),$cookieStore.put("globals",$rootScope.globals)},service.ClearCredentials=function(){localStorage.removeItem("usrData"),$rootScope.globals={},$cookieStore.remove("globals"),$http.defaults.headers.common.Authorization="Basic "},service}]).factory("Base64",function(){var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(input){var chr1,chr2,enc1,enc2,enc3,output="",chr3="",enc4="",i=0;do chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output=output+keyStr.charAt(enc1)+keyStr.charAt(enc2)+keyStr.charAt(enc3)+keyStr.charAt(enc4),chr1=chr2=chr3="",enc1=enc2=enc3=enc4="";while(i<input.length);return output},decode:function(input){var chr1,chr2,enc1,enc2,enc3,output="",chr3="",enc4="",i=0,base64test=/[^A-Za-z0-9\+\/\=]/g;base64test.exec(input)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do enc1=keyStr.indexOf(input.charAt(i++)),enc2=keyStr.indexOf(input.charAt(i++)),enc3=keyStr.indexOf(input.charAt(i++)),enc4=keyStr.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output+=String.fromCharCode(chr1),64!=enc3&&(output+=String.fromCharCode(chr2)),64!=enc4&&(output+=String.fromCharCode(chr3)),chr1=chr2=chr3="",enc1=enc2=enc3=enc4="";while(i<input.length);return output}}})}(),function(){function loginController(Auth,Users,GEO,generalConstructor,$scope,$rootScope,$location,$routeParams,AuthenticationService){$scope.Nickname="",$scope.RegData={_id:null,Address:"Calculando...",Photo:"images/empty_photo_150.png"},$scope.GEOInfo={},$scope.EmailRecover="",$scope.Login=function(e){AuthenticationService.Login($scope.Nickname,function(response){response.success?(AuthenticationService.SetCredentials(response.success),toastr.success("Autenticaci贸n satisfactoria!"),$("#modalLogin").modal("hide"),setTimeout(function(){location.reload("#/home")},500)):toastr.error(response.Msg)})},$scope.Register=function(e){var obj={User:$scope.RegData};Users.CrearEditarUsuario(obj).$promise.then(function(response){toastr.success("Registro satisfactorio"),setTimeout(function(){location.reload()},500)}).catch(function(response){console.log(response)})},$scope.Recover=function(e){var obj={User:{Email:$scope.EmailRecover}};Auth.RecuperarUsuario(obj).$promise.then(function(response){"success"==response.status?(toastr.success(response.Msg),setTimeout(function(){location.reload()},500)):toastr.error(response.Msg)}).catch(function(response){console.log(response)})},$scope.choosePhoto=function(){$("#photoRegSelect").trigger("click")},$scope.getGEOInfo=function(){navigator.geolocation.getCurrentPosition(function(position){$scope.GEOInfo.coords=position.coords;var obj=$scope.GEOInfo.coords;GEO.GetGEOLocation({lat:obj.latitude,long:obj.longitude}).$promise.then(function(response){response.results.length>0?$scope.RegData.Address=response.results[0].formatted_address:($scope.RegData.Address="",toastr.error("Error al obtener la direcci贸n"))}).catch(function(response){toastr.error("Error al obtener la direcci贸n")})})},generalConstructor.modals($scope),$scope.openModal("modalLogin"),$scope.photoRegSelected=function(){var file=document.getElementById("photoRegSelect").files[0],img=document.createElement("img"),reader=new FileReader;reader.onload=function(e){img.src=e.target.result;var canvas=document.createElement("canvas"),MAX_WIDTH=150,MAX_HEIGHT=150,width=img.width,height=img.height;width>height?width>MAX_WIDTH&&(height*=MAX_WIDTH/width,width=MAX_WIDTH):height>MAX_HEIGHT&&(width*=MAX_HEIGHT/height,height=MAX_HEIGHT),canvas.width=width,canvas.height=height;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0,width,height);var dataurl=canvas.toDataURL("image/png");$scope.RegData.Photo=dataurl,$scope.$apply()},reader.readAsDataURL(file)}}app.controller("loginController",loginController);loginController.$inject=["Auth","Users","GEO","generalConstructor","$scope","$rootScope","$location","$routeParams","AuthenticationService"]}(),function(){function registerController($scope,$rootScope,$location,$routeParams){alert("Hola mundo!")}app.controller("registerController",registerController);registerController.$inject=["$scope","$rootScope","$location","$routeParams"]}(),function(){function desktopController(Users,$scope,$rootScope,$location,$routeParams,AuthenticationService){$scope.pathToBackground="/images/ubuntu1.jpg",$scope.usrLogged=!1;var credentials=$rootScope.globals.currentUser;JSON.parse(localStorage.getItem("usrData"));credentials?($scope.loggedUserInfo="Hola, "+credentials.nick,$scope.usrLogged=!0):($scope.loggedUserInfo="Iniciar sesi贸n",$scope.usrLogged=!1,$("#userInfo").addClass("likeAnchor"),$("#userInfo").click(function(){$("#modalLogin").modal("show")})),$scope.goFullScreen=function(){screenfull.enabled&&screenfull.toggle()},$scope.Logout=function(){AuthenticationService.ClearCredentials(),location.reload("#/login")}}app.controller("desktopController",desktopController);desktopController.$inject=["Users","$scope","$rootScope","$location","$routeParams","AuthenticationService"]}(),function(){function homeController(Users,generalConstructor,$scope,$rootScope,$location,$window,$routeParams){var vm=new Ventus.WindowManager;$scope.gchatWindow=void 0;var width=$(window).width(),height=$(window).height(),socket=io.connect();$scope.windowStatus=!0,$scope.windowNotVisible=!1,$scope.unSeenMsg=0,generalConstructor.modals($scope);var favicon=new Favico({animation:"slide"});$scope.usrData=JSON.parse(localStorage.getItem("usrData")),$scope.messages=[],$scope.blurMsgs=[],$scope.inputMsg="",$scope.contacts=[],Users.ObtenerUsuarios().$promise.then(function(response){$scope.contacts=response.Users}).catch(function(response){console.log(response)}),$scope.openGChatWindow=function(){$scope.gchatWindow.open()},$scope.defineChatWindow=function(){$("#globalChat").removeClass("displayNone"),$scope.gchatWindow=vm.createWindow.fromQuery("#globalChat",{title:"Sala General",classname:"globalChatWindow",width:2*(width/3),height:5*(height/6),x:width/6,y:height/8,resizable:!1,events:{open:function(){setTimeout(function(){$(".chatMsgs").animate({scrollTop:$(".chatMsgs").prop("scrollHeight")},500),$(".chatInput").focus()},500)}}}),$("#globalChat").css("width",2*(width/3)),$("#globalChat").css("height",5*(height/6))},$scope.SendMsg=function(){var nick=$scope.usrData.Nombre,now=moment().format("DD/MM/YYYY HH:mm"),msg=this.inputMsg,obj={Sender:nick,Msg:msg,Date:now,Type:"msg"};""!=this.inputMsg&&(socket.emit("broadcast",obj),this.inputMsg="",$scope.messages=$scope.messages.filter(function(obj){return"msg"==obj.Type}))},socket.on("serverSays",function(msg){$scope.windowStatus||($scope.unSeenMsg++,favicon.badge($scope.unSeenMsg),$scope.windowNotVisible||($scope.windowNotVisible=!0,$scope.messages.push({Type:"separator"}))),$scope.messages.push(msg),$scope.$apply(),$(".chatMsgs").scrollTop($(".chatMsgs")[0].scrollHeight)}),$window.onfocus=function(){$scope.windowStatus=!0,$scope.unSeenMsg=0,favicon.badge($scope.unSeenMsg),$scope.windowNotVisible=!1},$window.onblur=function(){$scope.windowStatus=!1}}app.controller("homeController",homeController);homeController.$inject=["Users","generalConstructor","$scope","$rootScope","$location","$window","$routeParams"]}(),function(){function userInfoController(Users,$scope,$rootScope,$location,$routeParams,AuthenticationService){$scope.usrData=JSON.parse(localStorage.getItem("usrData")),$("#modalUserInfo").modal("show")}app.controller("userInfoController",userInfoController);userInfoController.$inject=["Users","$scope","$rootScope","$location","$routeParams","AuthenticationService"]}();